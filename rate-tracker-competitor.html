<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0a0a">
<title>Competitor Rate Tracker ‚Äî Oney & Co</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  /* ‚îÄ‚îÄ Dark Mode (default) ‚îÄ‚îÄ */
  :root {
    --green: #2ECC85;
    --green2: #1FAD73;
    --bg: #0a0a0a;
    --bg2: #111113;
    --bg3: #1a1a1e;
    --bg4: #222228;
    --border: #2a2a30;
    --text: #e8e8ec;
    --text2: #a0a0a8;
    --text3: #666670;
    --red: #ff4d6a;
    --red-bg: rgba(255,77,106,0.08);
    --green-bg: rgba(46,204,133,0.08);
    --yellow: #f59e0b;
    --yellow-bg: rgba(245,158,11,0.12);
    --yellow-border: rgba(245,158,11,0.3);
    --blue: #60a5fa;
    --purple: #c084fc;
    --radius: 12px;
    --radius-sm: 8px;
    --logo-text: #e8e8ec;
  }

  /* ‚îÄ‚îÄ Light Mode ‚îÄ‚îÄ */
  html.light {
    --bg: #f5f5f5;
    --bg2: #ffffff;
    --bg3: #f0f0f2;
    --bg4: #e4e4e8;
    --border: #d8d8dc;
    --text: #0a0a0a;
    --text2: #555560;
    --text3: #888890;
    --red: #dc2626;
    --red-bg: rgba(220,38,38,0.08);
    --green-bg: rgba(46,204,133,0.10);
    --yellow-bg: rgba(245,158,11,0.10);
    --yellow-border: rgba(245,158,11,0.4);
    --logo-text: #0a0a0a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body, .header, .main, .stat-card, .table-wrap, .btn, th, td,
  .tab-btn, select.filter-select, .modal, .toast, .legend, .footer,
  .rate-input, .form-group input, .form-group select, .rba-card,
  .mode-toggle, .step-card, .rate-card-grid, .comm-rate-card, .comm-disclaimer {
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* Header */
  .header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
  }

  .header-inner {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .back-btn {
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text2);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.15s;
    font-family: inherit;
    white-space: nowrap;
  }

  .back-btn:hover { background: var(--bg4); border-color: var(--green); color: var(--green); }

  .logo svg { height: 40px; width: auto; }

  .header-title {
    display: flex;
    flex-direction: column;
  }

  .header-title h1 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .header-title span {
    font-size: 12px;
    color: var(--text3);
    font-weight: 400;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }

  /* Theme Toggle */
  .theme-toggle {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border);
    border-radius: 50%;
    background: var(--bg3);
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .theme-toggle:hover {
    border-color: var(--green);
    color: var(--green);
    background: var(--green-bg);
  }

  .theme-toggle .icon-sun,
  .theme-toggle .icon-moon {
    position: absolute;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  .theme-toggle .icon-sun {
    opacity: 0;
    transform: rotate(-90deg) scale(0);
  }
  .theme-toggle .icon-moon {
    opacity: 1;
    transform: rotate(0) scale(1);
  }

  html.light .theme-toggle .icon-sun {
    opacity: 1;
    transform: rotate(0) scale(1);
  }
  html.light .theme-toggle .icon-moon {
    opacity: 0;
    transform: rotate(90deg) scale(0);
  }

  /* Buttons */
  .btn {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
    font-family: inherit;
  }

  .btn:hover { background: var(--bg4); border-color: var(--text3); }

  .btn-primary {
    background: linear-gradient(135deg, var(--green), var(--green2));
    border-color: transparent;
    color: #000;
    font-weight: 600;
  }

  .btn-primary:hover { opacity: 0.9; border-color: transparent; }

  .btn-danger {
    color: var(--red);
    border-color: rgba(255,77,106,0.3);
  }

  .btn-danger:hover { background: var(--red-bg); }

  .btn-sm { padding: 4px 10px; font-size: 12px; }

  /* Main Layout */
  .main {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
  }

  /* ‚ïê‚ïê MODE TOGGLE (Residential / Commercial) ‚ïê‚ïê */
  .mode-toggle {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  .mode-btn {
    flex: 1;
    max-width: 300px;
    padding: 16px 24px;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    background: var(--bg2);
    color: var(--text2);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s;
    font-family: inherit;
  }

  .mode-btn:hover {
    border-color: var(--green);
    color: var(--text);
    background: var(--bg3);
  }

  .mode-btn.active {
    border-color: var(--green);
    background: var(--green-bg);
    color: var(--green);
    box-shadow: 0 0 0 3px rgba(46,204,133,0.1);
  }

  .mode-btn .mode-icon {
    font-size: 24px;
  }

  .mode-btn .mode-label {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .mode-btn .mode-label small {
    font-size: 11px;
    font-weight: 400;
    color: var(--text3);
  }

  .mode-btn.active .mode-label small {
    color: var(--green);
    opacity: 0.7;
  }

  /* RBA Decision Day Card */
  .rba-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .rba-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .rba-icon {
    font-size: 28px;
  }

  .rba-info {
    display: flex;
    flex-direction: column;
  }

  .rba-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text3);
  }

  .rba-date {
    font-size: 18px;
    font-weight: 700;
    color: var(--green);
  }

  .rba-countdown {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .countdown-unit {
    text-align: center;
  }

  .countdown-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
    line-height: 1;
    font-variant-numeric: tabular-nums;
  }

  .countdown-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text3);
    font-weight: 500;
  }

  .countdown-sep {
    font-size: 20px;
    color: var(--text3);
    font-weight: 300;
    margin-top: -10px;
  }

  .rba-past {
    font-size: 13px;
    color: var(--text2);
    font-weight: 500;
  }

  /* Controls Bar */
  .controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab-group {
    display: flex;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .tab-btn {
    padding: 8px 20px;
    background: transparent;
    border: none;
    color: var(--text2);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    border-right: 1px solid var(--border);
  }

  .tab-btn:last-child { border-right: none; }

  .tab-btn.active {
    background: linear-gradient(135deg, var(--green), var(--green2));
    color: #000;
    font-weight: 600;
  }

  .tab-btn:not(.active):hover {
    background: var(--bg3);
    color: var(--text);
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-label {
    font-size: 12px;
    color: var(--text3);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  select.filter-select {
    padding: 8px 32px 8px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg2);
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666670' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
  }

  select.filter-select:focus { outline: none; border-color: var(--green); }

  .spacer { flex: 1; }

  .last-updated {
    font-size: 12px;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text3);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
  }

  .stat-value.green { color: var(--green); }
  .stat-value.red { color: var(--red); }

  .stat-sub {
    font-size: 12px;
    color: var(--text3);
    margin-top: 2px;
  }

  /* Table Container */
  .table-wrap {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
  }

  .table-header h2 {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 600;
  }

  .badge-big4 { background: rgba(59,130,246,0.15); color: #60a5fa; }
  .badge-nonmajor { background: rgba(168,85,247,0.15); color: #c084fc; }
  .badge-nonbank { background: rgba(251,146,60,0.15); color: #fb923c; }

  .table-scroll {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
  }

  th {
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    background: var(--bg3);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
    position: relative;
  }

  th:hover { color: var(--text); }

  th.sorted { color: var(--green); }

  th .sort-icon {
    font-size: 10px;
    margin-left: 4px;
    opacity: 0.4;
  }

  th.sorted .sort-icon { opacity: 1; }

  td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    white-space: nowrap;
  }

  tr:last-child td { border-bottom: none; }

  tr:hover td { background: rgba(46,204,133,0.03); }

  .bank-name {
    font-weight: 600;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .bank-tier {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .tier-big4 { background: #60a5fa; }
  .tier-nonmajor { background: #c084fc; }
  .tier-nonbank { background: #fb923c; }

  /* Rate Cell */
  .rate-cell {
    position: relative;
    min-width: 90px;
  }

  .rate-display {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: background 0.15s;
  }

  .rate-display:hover { background: var(--bg4); }

  .rate-value {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    font-size: 14px;
  }

  .rate-empty {
    color: var(--text3);
    font-style: italic;
    font-weight: 400;
    font-size: 12px;
  }

  .rate-change {
    font-size: 10px;
    font-weight: 600;
    padding: 1px 5px;
    border-radius: 4px;
  }

  .rate-up {
    color: var(--red);
    background: var(--red-bg);
  }

  .rate-down {
    color: var(--green);
    background: var(--green-bg);
  }

  .rate-highlight-up {
    animation: flashRed 2s ease-out;
  }

  .rate-highlight-down {
    animation: flashGreen 2s ease-out;
  }

  @keyframes flashRed {
    0% { background: rgba(255,77,106,0.2); }
    100% { background: transparent; }
  }

  @keyframes flashGreen {
    0% { background: rgba(46,204,133,0.2); }
    100% { background: transparent; }
  }

  /* Rate Input */
  .rate-input {
    width: 80px;
    padding: 4px 8px;
    border: 2px solid var(--green);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    font-family: inherit;
    text-align: center;
    outline: none;
  }

  .rate-input:focus { box-shadow: 0 0 0 3px rgba(46,204,133,0.2); }

  .updated-time {
    font-size: 11px;
    color: var(--text3);
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 20px;
    font-size: 13px;
    color: var(--text);
    z-index: 200;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toast.show { transform: translateY(0); opacity: 1; }
  .toast .toast-icon { font-size: 16px; }

  /* Legend */
  .legend {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg3);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text2);
  }

  /* ‚ïê‚ïê COMMERCIAL MODE STYLES ‚ïê‚ïê */

  /* Step Progress */
  .comm-steps-progress {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .step-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text3);
    padding: 6px 14px;
    border-radius: 20px;
    background: var(--bg3);
    border: 1px solid var(--border);
    transition: all 0.2s;
  }

  .step-indicator.active {
    color: var(--green);
    border-color: var(--green);
    background: var(--green-bg);
  }

  .step-indicator.completed {
    color: var(--green);
    border-color: rgba(46,204,133,0.3);
    background: var(--green-bg);
    cursor: pointer;
  }

  .step-indicator.completed:hover {
    border-color: var(--green);
  }

  .step-arrow {
    color: var(--text3);
    font-size: 14px;
  }

  /* Step Cards */
  .step-section {
    margin-bottom: 24px;
  }

  .step-section h3 {
    font-size: 15px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .step-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
  }

  .step-card {
    background: var(--bg2);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 8px;
  }

  .step-card:hover {
    border-color: var(--green);
    background: var(--bg3);
    transform: translateY(-2px);
  }

  .step-card.selected {
    border-color: var(--green);
    background: var(--green-bg);
    box-shadow: 0 0 0 3px rgba(46,204,133,0.1);
  }

  .step-card .card-icon {
    font-size: 36px;
    margin-bottom: 4px;
  }

  .step-card .card-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  .step-card.selected .card-title {
    color: var(--green);
  }

  .step-card .card-desc {
    font-size: 12px;
    color: var(--text3);
    line-height: 1.4;
  }

  /* Commercial Disclaimer */
  .comm-disclaimer {
    background: var(--yellow-bg);
    border: 1px solid var(--yellow-border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 13px;
    color: var(--text);
    line-height: 1.6;
  }

  .comm-disclaimer .disc-icon {
    font-size: 24px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .comm-disclaimer strong {
    color: var(--yellow);
  }

  /* Commercial Rate Cards */
  .comm-rate-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .comm-rate-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s;
  }

  .comm-rate-card:hover {
    border-color: var(--green);
    transform: translateY(-1px);
  }

  .comm-rate-card .card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .comm-rate-card .bank-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .comm-rate-card .bank-label {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
  }

  .comm-rate-card .tier-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
    margin-left: auto;
  }

  .comm-rate-card .rate-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
  }

  .comm-rate-card .rate-label {
    font-size: 12px;
    color: var(--text3);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .comm-rate-card .rate-num {
    font-size: 28px;
    font-weight: 800;
    color: var(--green);
    font-variant-numeric: tabular-nums;
  }

  .comm-rate-card .rate-num.contact {
    font-size: 13px;
    font-weight: 600;
    color: var(--text3);
    font-style: italic;
  }

  .comm-rate-card .rate-note {
    font-size: 11px;
    color: var(--text3);
    margin-top: 4px;
    font-style: italic;
  }

  .comm-rate-card .rate-source {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--green-bg);
    color: var(--green);
    font-weight: 600;
    margin-top: 8px;
  }

  .comm-rate-card .rate-source.manual-source {
    background: rgba(168,85,247,0.12);
    color: var(--purple);
  }

  /* Back button in steps */
  .step-back-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text2);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
    margin-bottom: 16px;
  }

  .step-back-btn:hover {
    border-color: var(--green);
    color: var(--green);
    background: var(--bg4);
  }

  /* Commercial summary header */
  .comm-selection-summary {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .comm-selection-summary .sel-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    background: var(--green-bg);
    border: 1px solid rgba(46,204,133,0.2);
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
  }

  .comm-selection-summary .sel-arrow {
    color: var(--text3);
    font-size: 14px;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 32px 24px;
    font-size: 12px;
    color: var(--text3);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main { padding: 12px; }
    .header { padding: 12px 16px; }
    .header-title h1 { font-size: 15px; }
    .controls { gap: 8px; }
    .tab-btn { padding: 6px 12px; font-size: 12px; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    th, td { padding: 8px 10px; font-size: 12px; }
    .rate-value { font-size: 13px; }
    .table-header { padding: 12px 16px; }
    .rba-card { flex-direction: column; align-items: flex-start; }
    .rba-countdown { width: 100%; justify-content: center; }
    .countdown-value { font-size: 20px; }
    .mode-toggle { flex-direction: column; }
    .mode-btn { max-width: 100%; }
    .step-cards { grid-template-columns: 1fr; }
    .comm-rate-grid { grid-template-columns: 1fr; }
    .comm-steps-progress { gap: 4px; }
    .step-indicator { font-size: 11px; padding: 4px 10px; }
  }

  @media (max-width: 480px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
    .header-actions { width: 100%; justify-content: flex-end; }
    .filter-group { width: 100%; }
    select.filter-select { flex: 1; }
  }

  /* Scroll hint */
  .scroll-hint {
    display: none;
    text-align: center;
    font-size: 11px;
    color: var(--text3);
    padding: 6px;
  }

  @media (max-width: 768px) {
    .scroll-hint { display: block; }
  }

  /* Print */
  @media print {
    .header { position: relative; }
    .theme-toggle, .back-btn { display: none; }
  }

  /* Fade transition */
  .fade-in {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Hide sections */
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-left">
      <a href="index.html" class="back-btn">‚Üê Back to Oney Tools</a>
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 190 90">
          <defs><linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#2ECC85"/><stop offset="100%" style="stop-color:#1FAD73"/></linearGradient></defs>
          <g transform="translate(38, 45)"><path d="M 0 -32 A 32 32 0 1 0 0 -31.99" fill="none" stroke="url(#greenGrad)" stroke-width="7" stroke-linecap="round" stroke-dasharray="191 10"/><path d="M0 -38 L0 -44" stroke="url(#greenGrad)" stroke-width="5" stroke-linecap="round"/></g>
          <text x="32" y="50" font-family="Inter, Arial, sans-serif" font-size="26" font-weight="600" fill="var(--logo-text)">ney</text>
          <text x="77" y="50" font-family="Inter, Arial, sans-serif" font-size="20" font-weight="400" fill="url(#greenGrad)">&amp;</text>
          <text x="94" y="50" font-family="Inter, Arial, sans-serif" font-size="26" font-weight="600" fill="var(--logo-text)">co</text>
        </svg>
      </div>
      <div class="header-title">
        <h1>üìä Competitor Rate Tracker</h1>
        <span>Monitor & compare lender rates across the market</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark/light mode">
        <span class="icon-sun">‚òÄÔ∏è</span>
        <span class="icon-moon">üåô</span>
      </button>
      <button class="btn btn-primary" onclick="refreshRatesFromAPI()" id="refreshBtn">üîÑ Refresh Rates</button>
      <button class="btn" onclick="exportCSV()" id="exportBtn">üì• Export CSV</button>
      <button class="btn btn-danger" onclick="confirmClearAll()" id="clearBtn">üóëÔ∏è Clear All</button>
    </div>
  </div>
</div>

<div class="main">

  <!-- ‚ïê‚ïê MODE TOGGLE ‚ïê‚ïê -->
  <div class="mode-toggle">
    <button class="mode-btn active" id="modeResidential" onclick="switchMode('residential')">
      <span class="mode-icon">üè†</span>
      <span class="mode-label">
        Residential
        <small>Home loans & investment</small>
      </span>
    </button>
    <button class="mode-btn" id="modeCommercial" onclick="switchMode('commercial')">
      <span class="mode-icon">üè¢</span>
      <span class="mode-label">
        Commercial
        <small>Business & commercial lending</small>
      </span>
    </button>
  </div>

  <!-- ‚ïê‚ïê RESIDENTIAL SECTION ‚ïê‚ïê -->
  <div id="residentialSection">

    <!-- RBA Decision Day -->
    <div class="rba-card" id="rbaCard">
      <div class="rba-left">
        <div class="rba-icon">üèõÔ∏è</div>
        <div class="rba-info">
          <span class="rba-label">Next RBA Decision Day</span>
          <span class="rba-date" id="rbaDate">‚Äî</span>
        </div>
      </div>
      <div class="rba-countdown" id="rbaCountdown"></div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="tab-group" id="categoryTabs">
        <button class="tab-btn active" data-cat="residential" onclick="switchCategory('residential')">üè† Owner Occupied</button>
        <button class="tab-btn" data-cat="commercial" onclick="switchCategory('commercial')">üìà Investment</button>
      </div>

      <div class="filter-group">
        <span class="filter-label">LVR</span>
        <select class="filter-select" id="lvrFilter" onchange="renderTables()">
          <option value="all">All LVR Tiers</option>
          <option value="60">‚â§ 60%</option>
          <option value="70">‚â§ 70%</option>
          <option value="80">‚â§ 80%</option>
          <option value="80+">Ôºû 80%</option>
        </select>
      </div>

      <div class="filter-group">
        <span class="filter-label">Product</span>
        <select class="filter-select" id="productFilter" onchange="renderTables()">
          <option value="all">All Products</option>
          <option value="variable">Variable</option>
          <option value="fixed1">Fixed 1yr</option>
          <option value="fixed2">Fixed 2yr</option>
          <option value="fixed3">Fixed 3yr</option>
        </select>
      </div>

      <div class="spacer"></div>

      <div class="last-updated" id="lastUpdatedGlobal">
        üïê No data yet
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <div class="stat-label">Rates Tracked</div>
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-sub">across all lenders</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Lowest Variable</div>
        <div class="stat-value green" id="statLowest">‚Äî</div>
        <div class="stat-sub" id="statLowestBank">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Highest Variable</div>
        <div class="stat-value red" id="statHighest">‚Äî</div>
        <div class="stat-sub" id="statHighestBank">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Variable</div>
        <div class="stat-value" id="statAvg">‚Äî</div>
        <div class="stat-sub">market average</div>
      </div>
    </div>

    <!-- Tables rendered here -->
    <div id="tablesContainer"></div>

  </div><!-- /residentialSection -->

  <!-- ‚ïê‚ïê COMMERCIAL SECTION ‚ïê‚ïê -->
  <div id="commercialSection" class="hidden">

    <!-- Disclaimer -->
    <div class="comm-disclaimer">
      <span class="disc-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Indicative rates only.</strong> Commercial lending pricing is subject to multiple factors including security type, LVR, industry, facility size, and relationship. Always confirm with your lender or banker for actual pricing.
      </div>
    </div>

    <!-- Step Progress Indicators -->
    <div class="comm-steps-progress" id="commStepsProgress">
      <!-- Populated dynamically -->
    </div>

    <!-- Commercial Flow Container -->
    <div id="commFlowContainer">
      <!-- Populated dynamically by JS -->
    </div>

    <!-- CDR timestamp for commercial -->
    <div class="last-updated" id="commLastUpdated" style="margin-top:16px;">
      üïê No data yet
    </div>

  </div><!-- /commercialSection -->

</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-icon">‚úÖ</span>
  <span id="toastMsg">Saved</span>
</div>

<!-- Footer -->
<div class="footer">
  Oney & Co ‚Äî Competitor Rate Tracker ¬∑ Rate data sourced from <a href="https://www.cdr.gov.au/" target="_blank" style="color:var(--green)">CDR Open Banking API</a> ¬∑ Manual edits stored locally in your browser
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initTheme() {
  const saved = localStorage.getItem('oney-rate-tracker-theme');
  if (saved === 'light') {
    document.documentElement.classList.add('light');
  }
}

function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('oney-rate-tracker-theme', isLight ? 'light' : 'dark');
}

initTheme();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ RBA Decision Day ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RBA_DATES_2026 = [
  new Date(2026, 1, 18),
  new Date(2026, 3, 1),
  new Date(2026, 4, 20),
  new Date(2026, 6, 1),
  new Date(2026, 7, 12),
  new Date(2026, 8, 23),
  new Date(2026, 10, 4),
  new Date(2026, 11, 9),
];

function updateRBACountdown() {
  const now = new Date();
  let nextDate = null;

  for (const d of RBA_DATES_2026) {
    if (d >= now) { nextDate = d; break; }
  }

  const dateEl = document.getElementById('rbaDate');
  const countdownEl = document.getElementById('rbaCountdown');

  if (!nextDate) {
    dateEl.textContent = 'No more meetings in 2026';
    countdownEl.innerHTML = '<span class="rba-past">All 2026 RBA meetings have passed</span>';
    return;
  }

  const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
  dateEl.textContent = nextDate.toLocaleDateString('en-AU', options);

  const diff = nextDate - now;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  if (days === 0 && hours === 0 && mins === 0) {
    countdownEl.innerHTML = '<span class="rba-past" style="color:var(--green);font-weight:700;">üî¥ Decision Day is TODAY!</span>';
  } else {
    countdownEl.innerHTML = `
      <div class="countdown-unit">
        <div class="countdown-value">${days}</div>
        <div class="countdown-label">Days</div>
      </div>
      <span class="countdown-sep">:</span>
      <div class="countdown-unit">
        <div class="countdown-value">${String(hours).padStart(2,'0')}</div>
        <div class="countdown-label">Hours</div>
      </div>
      <span class="countdown-sep">:</span>
      <div class="countdown-unit">
        <div class="countdown-value">${String(mins).padStart(2,'0')}</div>
        <div class="countdown-label">Mins</div>
      </div>
    `;
  }
}

updateRBACountdown();
setInterval(updateRBACountdown, 60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Data Model (Residential) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BANKS = [
  { name: 'CBA', tier: 'big4' },
  { name: 'NAB', tier: 'big4' },
  { name: 'Westpac', tier: 'big4' },
  { name: 'ANZ', tier: 'big4' },
  { name: 'Macquarie', tier: 'nonmajor' },
  { name: 'ING', tier: 'nonmajor' },
  { name: 'Bankwest', tier: 'nonmajor' },
  { name: 'St George', tier: 'nonmajor' },
  { name: 'Suncorp', tier: 'nonmajor' },
  { name: 'Bendigo', tier: 'nonmajor' },
  { name: 'Pepper', tier: 'nonbank' },
  { name: 'Liberty', tier: 'nonbank' },
  { name: 'La Trobe', tier: 'nonbank' },
  { name: 'Firstmac', tier: 'nonbank' },
  { name: 'Resimac', tier: 'nonbank' },
];

const TIERS = {
  big4: { label: 'Big 4', badge: 'badge-big4', dot: 'tier-big4' },
  nonmajor: { label: 'Non-Major', badge: 'badge-nonmajor', dot: 'tier-nonmajor' },
  nonbank: { label: 'Non-Bank', badge: 'badge-nonbank', dot: 'tier-nonbank' },
};

const CATEGORIES = ['residential', 'commercial'];
const PRODUCTS = [
  { key: 'variable', label: 'Variable' },
  { key: 'fixed1', label: 'Fixed 1yr' },
  { key: 'fixed2', label: 'Fixed 2yr' },
  { key: 'fixed3', label: 'Fixed 3yr' },
];
const LVRS = [
  { key: '60', label: '‚â§ 60%' },
  { key: '70', label: '‚â§ 70%' },
  { key: '80', label: '‚â§ 80%' },
  { key: '80+', label: '> 80%' },
];

const STORAGE_KEY = 'oney_rate_tracker_v2';

let currentMode = 'residential'; // 'residential' or 'commercial'
let currentCategory = 'residential';
let rateData = {};
let sortState = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Commercial Data Model ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COMM_BANKS = [
  { name: 'CBA', tier: 'big4', displayName: 'Commonwealth Bank' },
  { name: 'Westpac', tier: 'big4', displayName: 'Westpac' },
  { name: 'NAB', tier: 'big4', displayName: 'National Australia Bank' },
  { name: 'ANZ', tier: 'big4', displayName: 'ANZ' },
  { name: 'Macquarie', tier: 'nonmajor', displayName: 'Macquarie Bank' },
  { name: 'ING', tier: 'nonmajor', displayName: 'ING' },
  { name: 'Bendigo', tier: 'nonmajor', displayName: 'Bendigo Bank' },
];

// Commercial rate state from CDR + manual
let commercialRates = {};
// Format: commercialRates[bankName][productKey] = { rate: 7.16, note: "Base Rate, a Margin may apply", source: 'cdr' }

// Commercial flow state
let commState = {
  loanType: null,      // 'term_debt' or 'working_capital'
  productType: null,   // term: 'cash_based' or 'bbsy', wc: 'overdraft' or 'loc'
  security: null,      // (for working_capital) 'secured' or 'unsecured'
};

const COMM_STORAGE_KEY = 'oney_comm_state_v1';

function saveCommState() {
  localStorage.setItem(COMM_STORAGE_KEY, JSON.stringify(commState));
}

function loadCommState() {
  try {
    const saved = localStorage.getItem(COMM_STORAGE_KEY);
    if (saved) commState = JSON.parse(saved);
  } catch(e) { /* ignore */ }
}

// Map commercial selections to CDR product keys
function getCommProductKey() {
  if (commState.loanType === 'term_debt') {
    if (commState.productType === 'cash_based') return 'secured_business_loan';
    if (commState.productType === 'bbsy') return 'bbsy_business_loan';
  }
  if (commState.loanType === 'working_capital') {
    const isOD = commState.productType === 'overdraft';
    const isLOC = commState.productType === 'loc';
    if (commState.security === 'secured') {
      return isOD ? 'business_overdraft' : 'business_loc_secured';
    }
    if (commState.security === 'unsecured') {
      return isOD ? 'unsecured_business_overdraft' : 'unsecured_business_loc';
    }
  }
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Persistence (Residential) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadData() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) rateData = JSON.parse(saved);
  } catch(e) {
    rateData = {};
  }
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rateData));
  updateGlobalTimestamp();
}

function makeKey(cat, bank, product, lvr) {
  return `${cat}|${bank}|${product}|${lvr}`;
}

function getRate(cat, bank, product, lvr) {
  const key = makeKey(cat, bank, product, lvr);
  return rateData[key] || null;
}

function setRate(cat, bank, product, lvr, value) {
  const key = makeKey(cat, bank, product, lvr);
  const existing = rateData[key];
  const newEntry = {
    value: value,
    prev: existing ? existing.value : null,
    updated: new Date().toISOString(),
  };
  rateData[key] = newEntry;
  saveData();
}

function deleteRate(cat, bank, product, lvr) {
  const key = makeKey(cat, bank, product, lvr);
  delete rateData[key];
  saveData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Mode Switch ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMode(mode) {
  currentMode = mode;

  document.getElementById('modeResidential').classList.toggle('active', mode === 'residential');
  document.getElementById('modeCommercial').classList.toggle('active', mode === 'commercial');

  document.getElementById('residentialSection').classList.toggle('hidden', mode !== 'residential');
  document.getElementById('commercialSection').classList.toggle('hidden', mode !== 'commercial');

  // Show/hide residential-only buttons
  document.getElementById('exportBtn').classList.toggle('hidden', mode !== 'residential');
  document.getElementById('clearBtn').classList.toggle('hidden', mode !== 'residential');

  if (mode === 'commercial') {
    renderCommercialFlow();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Residential UI (unchanged logic) ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('#categoryTabs .tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.cat === cat);
  });
  renderTables();
}

function getVisibleProducts() {
  const f = document.getElementById('productFilter').value;
  if (f === 'all') return PRODUCTS;
  return PRODUCTS.filter(p => p.key === f);
}

function getVisibleLVRs() {
  const f = document.getElementById('lvrFilter').value;
  if (f === 'all') return LVRS;
  return LVRS.filter(l => l.key === f);
}

function renderTables() {
  const container = document.getElementById('tablesContainer');
  const products = getVisibleProducts();
  const lvrs = getVisibleLVRs();

  const columns = [];
  for (const p of products) {
    for (const l of lvrs) {
      columns.push({ product: p, lvr: l, key: `${p.key}_${l.key}` });
    }
  }

  let html = '';

  for (const [tierKey, tierInfo] of Object.entries(TIERS)) {
    const banks = BANKS.filter(b => b.tier === tierKey);
    const sortKey = `${currentCategory}_${tierKey}`;

    html += `<div class="table-wrap">`;
    html += `<div class="table-header">
      <h2><span class="badge ${tierInfo.badge}">${tierInfo.label}</span> ${banks.length} lenders</h2>
    </div>`;
    html += `<div class="scroll-hint">‚Üê Scroll to see more ‚Üí</div>`;
    html += `<div class="table-scroll"><table>`;

    html += `<thead><tr>`;
    html += `<th style="min-width:120px;position:sticky;left:0;z-index:2;background:var(--bg3);" onclick="sortTable('${sortKey}','bank')">
      Bank <span class="sort-icon">${getSortIcon(sortKey, 'bank')}</span></th>`;
    for (const col of columns) {
      const colId = col.key;
      const label = columns.length <= 4
        ? `${col.product.label}<br>${col.lvr.label}`
        : `${col.product.label} ${col.lvr.label}`;
      html += `<th class="${isSorted(sortKey, colId) ? 'sorted' : ''}" onclick="sortTable('${sortKey}','${colId}')">
        ${label} <span class="sort-icon">${getSortIcon(sortKey, colId)}</span></th>`;
    }
    html += `<th>Updated</th>`;
    html += `</tr></thead>`;

    const sortedBanks = getSortedBanks(banks, columns, sortKey);

    html += `<tbody>`;
    for (const bank of sortedBanks) {
      html += `<tr>`;
      html += `<td style="position:sticky;left:0;z-index:1;background:var(--bg2);">
        <span class="bank-name"><span class="bank-tier ${tierInfo.dot}"></span>${bank.name}</span></td>`;

      let latestUpdate = null;

      for (const col of columns) {
        const entry = getRate(currentCategory, bank.name, col.product.key, col.lvr.key);
        const cellId = `cell_${currentCategory}_${bank.name}_${col.product.key}_${col.lvr.key}`.replace(/\s/g, '_');

        html += `<td class="rate-cell" id="${cellId}">`;
        if (entry && entry.value !== null && entry.value !== undefined) {
          let changeHtml = '';
          let highlightClass = '';
          if (entry.prev !== null && entry.prev !== undefined && entry.prev !== entry.value) {
            const diff = entry.value - entry.prev;
            if (diff > 0) {
              changeHtml = `<span class="rate-change rate-up">‚ñ≤ ${Math.abs(diff).toFixed(2)}</span>`;
              highlightClass = 'rate-highlight-up';
            } else {
              changeHtml = `<span class="rate-change rate-down">‚ñº ${Math.abs(diff).toFixed(2)}</span>`;
              highlightClass = 'rate-highlight-down';
            }
          }
          html += `<div class="rate-display ${highlightClass}" onclick="editRate('${currentCategory}','${bank.name}','${col.product.key}','${col.lvr.key}','${cellId}')">
            <span class="rate-value">${Number(entry.value).toFixed(2)}%</span>${changeHtml}</div>`;
          if (entry.updated) {
            const d = new Date(entry.updated);
            if (!latestUpdate || d > latestUpdate) latestUpdate = d;
          }
        } else {
          html += `<div class="rate-display" onclick="editRate('${currentCategory}','${bank.name}','${col.product.key}','${col.lvr.key}','${cellId}')">
            <span class="rate-empty">‚Äî</span></div>`;
        }
        html += `</td>`;
      }

      html += `<td class="updated-time">${latestUpdate ? formatTime(latestUpdate) : '‚Äî'}</td>`;
      html += `</tr>`;
    }
    html += `</tbody></table></div>`;

    html += `<div class="legend">
      <div class="legend-item">üí° Click any cell to enter/edit a rate</div>
      <div class="legend-item"><span class="rate-change rate-up" style="font-size:11px">‚ñ≤ Up</span> = Rate increased</div>
      <div class="legend-item"><span class="rate-change rate-down" style="font-size:11px">‚ñº Down</span> = Rate decreased</div>
    </div>`;

    html += `</div>`;
  }

  container.innerHTML = html;
  updateStats();
}

// ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ
function getSortIcon(sortKey, col) {
  const s = sortState[sortKey];
  if (!s || s.col !== col) return '‚áÖ';
  return s.asc ? '‚Üë' : '‚Üì';
}

function isSorted(sortKey, col) {
  const s = sortState[sortKey];
  return s && s.col === col;
}

function sortTable(sortKey, col) {
  const s = sortState[sortKey];
  if (s && s.col === col) {
    s.asc = !s.asc;
  } else {
    sortState[sortKey] = { col, asc: true };
  }
  renderTables();
}

function getSortedBanks(banks, columns, sortKey) {
  const s = sortState[sortKey];
  if (!s) return banks;

  const sorted = [...banks];
  const cat = currentCategory;

  if (s.col === 'bank') {
    sorted.sort((a, b) => a.name.localeCompare(b.name));
  } else {
    const col = columns.find(c => c.key === s.col);
    if (col) {
      sorted.sort((a, b) => {
        const ra = getRate(cat, a.name, col.product.key, col.lvr.key);
        const rb = getRate(cat, b.name, col.product.key, col.lvr.key);
        const va = ra ? ra.value : Infinity;
        const vb = rb ? rb.value : Infinity;
        return va - vb;
      });
    }
  }

  if (!s.asc) sorted.reverse();
  return sorted;
}

// ‚îÄ‚îÄ Edit Rate ‚îÄ‚îÄ
let currentEdit = null;

function editRate(cat, bank, product, lvr, cellId) {
  const cell = document.getElementById(cellId);
  if (!cell || currentEdit === cellId) return;

  if (currentEdit) renderTables();

  currentEdit = cellId;
  const entry = getRate(cat, bank, product, lvr);
  const val = entry ? Number(entry.value).toFixed(2) : '';

  cell.innerHTML = `<input type="number" class="rate-input" value="${val}" step="0.01" min="0" max="30"
    onkeydown="handleRateKey(event, '${cat}','${bank}','${product}','${lvr}')"
    onblur="saveRate(this, '${cat}','${bank}','${product}','${lvr}')"
    id="input_${cellId}">`;

  const input = cell.querySelector('input');
  input.focus();
  input.select();
}

function handleRateKey(e, cat, bank, product, lvr) {
  if (e.key === 'Enter') {
    e.target.blur();
  } else if (e.key === 'Escape') {
    currentEdit = null;
    renderTables();
  } else if (e.key === 'Delete' || (e.key === 'Backspace' && e.target.value === '')) {
    deleteRate(cat, bank, product, lvr);
    currentEdit = null;
    renderTables();
    showToast('Rate removed', 'üóëÔ∏è');
  }
}

function saveRate(input, cat, bank, product, lvr) {
  const val = parseFloat(input.value);
  currentEdit = null;
  if (!isNaN(val) && val > 0 && val <= 30) {
    setRate(cat, bank, product, lvr, val);
    showToast(`${bank} rate saved: ${val.toFixed(2)}%`);
  }
  renderTables();
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats() {
  const cat = currentCategory;
  let total = 0;
  let lowestVar = Infinity, highestVar = -Infinity;
  let lowestBank = '', highestBank = '';
  let varSum = 0, varCount = 0;

  for (const bank of BANKS) {
    for (const p of PRODUCTS) {
      for (const l of LVRS) {
        const entry = getRate(cat, bank.name, p.key, l.key);
        if (entry && entry.value !== null) {
          total++;
          if (p.key === 'variable') {
            varSum += entry.value;
            varCount++;
            if (entry.value < lowestVar) { lowestVar = entry.value; lowestBank = bank.name; }
            if (entry.value > highestVar) { highestVar = entry.value; highestBank = bank.name; }
          }
        }
      }
    }
  }

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statLowest').textContent = lowestVar < Infinity ? lowestVar.toFixed(2) + '%' : '‚Äî';
  document.getElementById('statLowestBank').textContent = lowestBank || '‚Äî';
  document.getElementById('statHighest').textContent = highestVar > -Infinity ? highestVar.toFixed(2) + '%' : '‚Äî';
  document.getElementById('statHighestBank').textContent = highestBank || '‚Äî';
  document.getElementById('statAvg').textContent = varCount > 0 ? (varSum / varCount).toFixed(2) + '%' : '‚Äî';
}

// ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
function exportCSV() {
  const cat = currentCategory;
  let csv = 'Bank,Tier,Product,LVR,Rate (%),Previous Rate (%),Change,Last Updated\n';

  for (const bank of BANKS) {
    for (const p of PRODUCTS) {
      for (const l of LVRS) {
        const entry = getRate(cat, bank.name, p.key, l.key);
        if (entry && entry.value !== null) {
          const change = (entry.prev !== null && entry.prev !== undefined)
            ? (entry.value - entry.prev).toFixed(2)
            : '';
          const updated = entry.updated ? new Date(entry.updated).toLocaleString() : '';
          csv += `"${bank.name}","${TIERS[bank.tier].label}","${p.label}","${l.label}",${entry.value.toFixed(2)},${entry.prev !== null && entry.prev !== undefined ? entry.prev.toFixed(2) : ''},${change},"${updated}"\n`;
        }
      }
    }
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `oney-rate-tracker-${cat}-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported successfully', 'üì•');
}

// ‚îÄ‚îÄ Clear All ‚îÄ‚îÄ
function confirmClearAll() {
  if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL rate data? This cannot be undone.')) {
    rateData = {};
    saveData();
    renderTables();
    showToast('All data cleared', 'üóëÔ∏è');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Commercial Flow UI ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCommercialFlow() {
  const container = document.getElementById('commFlowContainer');
  const progressEl = document.getElementById('commStepsProgress');

  // Determine current step
  let step = 1;
  if (commState.loanType) step = 2;
  if (commState.loanType === 'term_debt' && commState.productType) step = 3;
  if (commState.loanType === 'working_capital' && commState.productType && commState.security) step = 3;
  // Working capital needs security selection as part of step 2
  if (commState.loanType === 'working_capital' && commState.productType && !commState.security) step = 2;

  // Render progress
  let progressHtml = '';
  const steps = [
    { num: 1, label: 'Loan Type' },
    { num: 2, label: commState.loanType === 'term_debt' ? 'Product' : 'Product & Security' },
    { num: 3, label: 'Rates' },
  ];

  for (let i = 0; i < steps.length; i++) {
    const s = steps[i];
    let cls = '';
    if (s.num < step) cls = 'completed';
    else if (s.num === step) cls = 'active';

    const clickFn = s.num < step ? `onclick="commGoToStep(${s.num})"` : '';
    progressHtml += `<div class="step-indicator ${cls}" ${clickFn}>
      ${s.num < step ? '‚úÖ' : s.num === step ? 'üìç' : '‚óã'} Step ${s.num}: ${s.label}
    </div>`;
    if (i < steps.length - 1) {
      progressHtml += `<span class="step-arrow">‚Üí</span>`;
    }
  }
  progressEl.innerHTML = progressHtml;

  // Render step content
  let html = '<div class="fade-in">';

  if (step === 1) {
    html += renderCommStep1();
  } else if (step === 2) {
    html += renderCommStep2();
  } else if (step === 3) {
    html += renderCommStep3();
  }

  html += '</div>';
  container.innerHTML = html;
}

function renderCommStep1() {
  let html = '';
  html += `<div class="step-section">
    <h3>üìã Step 1: Select Loan Type</h3>
    <div class="step-cards">
      <div class="step-card ${commState.loanType === 'term_debt' ? 'selected' : ''}" onclick="commSelectLoanType('term_debt')">
        <span class="card-icon">üìä</span>
        <span class="card-title">Term Debt</span>
        <span class="card-desc">Medium to long-term business loans for asset purchases, expansion, or refinancing</span>
      </div>
      <div class="step-card ${commState.loanType === 'working_capital' ? 'selected' : ''}" onclick="commSelectLoanType('working_capital')">
        <span class="card-icon">üí∞</span>
        <span class="card-title">Working Capital</span>
        <span class="card-desc">Short-term facilities for operational cash flow, inventory, or day-to-day expenses</span>
      </div>
    </div>
  </div>`;
  return html;
}

function renderCommStep2() {
  let html = '';
  html += `<button class="step-back-btn" onclick="commGoToStep(1)">‚Üê Back to Loan Type</button>`;

  if (commState.loanType === 'term_debt') {
    html += `<div class="step-section">
      <h3>üè¶ Step 2: Select Product Type</h3>
      <div class="step-cards">
        <div class="step-card ${commState.productType === 'cash_based' ? 'selected' : ''}" onclick="commSelectProduct('cash_based')">
          <span class="card-icon">üè¶</span>
          <span class="card-title">Cash-based Product</span>
          <span class="card-desc">Variable rate, standard commercial loan secured by property or assets</span>
        </div>
        <div class="step-card ${commState.productType === 'bbsy' ? 'selected' : ''}" onclick="commSelectProduct('bbsy')">
          <span class="card-icon">üìà</span>
          <span class="card-title">BBSY Product</span>
          <span class="card-desc">Bank Bill Swap rate sensitive, typically for larger facilities ($1M+)</span>
        </div>
      </div>
    </div>`;
  } else if (commState.loanType === 'working_capital') {
    html += `<div class="step-section">
      <h3>üí≥ Step 2a: Select Product Type</h3>
      <div class="step-cards">
        <div class="step-card ${commState.productType === 'overdraft' ? 'selected' : ''}" onclick="commSelectProduct('overdraft')">
          <span class="card-icon">üí≥</span>
          <span class="card-title">Overdraft (OD)</span>
          <span class="card-desc">Flexible credit facility linked to your business account for ongoing working capital needs</span>
        </div>
        <div class="step-card ${commState.productType === 'loc' ? 'selected' : ''}" onclick="commSelectProduct('loc')">
          <span class="card-icon">üìã</span>
          <span class="card-title">Line of Credit (LOC)</span>
          <span class="card-desc">Revolving credit facility ‚Äî draw down and repay as needed, interest only on drawn amount</span>
        </div>
      </div>
    </div>`;

    // Show security selection if product is chosen
    if (commState.productType) {
      html += `<div class="step-section" style="margin-top:16px;">
        <h3>üîí Step 2b: Security Type</h3>
        <div class="step-cards">
          <div class="step-card ${commState.security === 'secured' ? 'selected' : ''}" onclick="commSelectSecurity('secured')">
            <span class="card-icon">‚úÖ</span>
            <span class="card-title">With Tangible Security</span>
            <span class="card-desc">Secured by property, equipment, or other tangible assets ‚Äî typically lower rates</span>
          </div>
          <div class="step-card ${commState.security === 'unsecured' ? 'selected' : ''}" onclick="commSelectSecurity('unsecured')">
            <span class="card-icon">‚ùå</span>
            <span class="card-title">Without Tangible Security</span>
            <span class="card-desc">Unsecured facility ‚Äî higher rates but no asset encumbrance required</span>
          </div>
        </div>
      </div>`;
    }
  }

  return html;
}

function renderCommStep3() {
  let html = '';
  html += `<button class="step-back-btn" onclick="commGoToStep(2)">‚Üê Back to Product Selection</button>`;

  // Selection summary
  const chips = getSelectionChips();
  html += `<div class="comm-selection-summary">`;
  for (let i = 0; i < chips.length; i++) {
    html += `<span class="sel-chip">${chips[i]}</span>`;
    if (i < chips.length - 1) html += `<span class="sel-arrow">‚Üí</span>`;
  }
  html += `</div>`;

  // Get commercial rates for this selection
  const productKey = getCommProductKey();
  const rates = getCommRatesForProduct(productKey);

  html += `<div class="step-section">
    <h3>üìä Variable Indicative Rates</h3>
    <div class="comm-rate-grid">`;

  for (const bank of COMM_BANKS) {
    const rateInfo = rates[bank.name] || { rate: null, note: 'Contact lender for pricing', source: 'none' };
    const tierInfo = TIERS[bank.tier];

    html += `<div class="comm-rate-card">
      <div class="card-header">
        <span class="bank-dot" style="background:${bank.tier === 'big4' ? '#60a5fa' : bank.tier === 'nonmajor' ? '#c084fc' : '#fb923c'}"></span>
        <span class="bank-label">${bank.name}</span>
        <span class="tier-badge ${tierInfo.badge}">${tierInfo.label}</span>
      </div>
      <div class="rate-row">
        <span class="rate-label">Variable Rate</span>
      </div>
      <div class="rate-row">`;

    if (rateInfo.rate !== null) {
      html += `<span class="rate-num">${Number(rateInfo.rate).toFixed(2)}%</span>`;
    } else {
      html += `<span class="rate-num contact">${rateInfo.note || 'Contact lender for pricing'}</span>`;
    }

    html += `</div>`;

    if (rateInfo.additionalInfo) {
      html += `<div class="rate-note">${rateInfo.additionalInfo}</div>`;
    }

    if (rateInfo.source === 'cdr') {
      html += `<span class="rate-source">ü§ñ CDR Data</span>`;
    } else if (rateInfo.source === 'manual') {
      html += `<span class="rate-source manual-source">‚úèÔ∏è Manual</span>`;
    }

    html += `</div>`;
  }

  html += `</div></div>`;

  return html;
}

function getSelectionChips() {
  const chips = [];
  if (commState.loanType === 'term_debt') chips.push('üìä Term Debt');
  if (commState.loanType === 'working_capital') chips.push('üí∞ Working Capital');

  if (commState.productType === 'cash_based') chips.push('üè¶ Cash-based');
  if (commState.productType === 'bbsy') chips.push('üìà BBSY');
  if (commState.productType === 'overdraft') chips.push('üí≥ Overdraft');
  if (commState.productType === 'loc') chips.push('üìã Line of Credit');

  if (commState.security === 'secured') chips.push('‚úÖ Secured');
  if (commState.security === 'unsecured') chips.push('‚ùå Unsecured');

  return chips;
}

function getCommRatesForProduct(productKey) {
  const rates = {};

  for (const bank of COMM_BANKS) {
    if (commercialRates[bank.name] && commercialRates[bank.name][productKey]) {
      rates[bank.name] = commercialRates[bank.name][productKey];
    } else {
      rates[bank.name] = { rate: null, note: 'Contact lender for pricing', source: 'none' };
    }
  }

  return rates;
}

// ‚îÄ‚îÄ Commercial Navigation ‚îÄ‚îÄ
function commSelectLoanType(type) {
  commState.loanType = type;
  commState.productType = null;
  commState.security = null;
  saveCommState();
  renderCommercialFlow();
}

function commSelectProduct(product) {
  commState.productType = product;
  // For term debt, go directly to step 3 (no security selection needed)
  if (commState.loanType === 'term_debt') {
    commState.security = null;
    saveCommState();
    renderCommercialFlow();
  } else {
    // Working capital: need to select security still
    commState.security = null;
    saveCommState();
    renderCommercialFlow();
  }
}

function commSelectSecurity(security) {
  commState.security = security;
  saveCommState();
  renderCommercialFlow();
}

function commGoToStep(step) {
  if (step === 1) {
    commState.loanType = null;
    commState.productType = null;
    commState.security = null;
  } else if (step === 2) {
    commState.productType = null;
    commState.security = null;
  }
  saveCommState();
  renderCommercialFlow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatTime(date) {
  const now = new Date();
  const diff = now - date;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
}

function updateGlobalTimestamp() {
  let latest = null;
  for (const key in rateData) {
    const d = rateData[key].updated;
    if (d) {
      const dt = new Date(d);
      if (!latest || dt > latest) latest = dt;
    }
  }
  const el = document.getElementById('lastUpdatedGlobal');
  el.textContent = latest ? `üïê Last updated: ${formatTime(latest)}` : 'üïê No data yet';
}

function showToast(msg, icon = '‚úÖ') {
  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  toast.querySelector('.toast-icon').textContent = icon;
  toastMsg.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CDR Auto-Fetch from rates.json ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CDR_BANK_MAP = {
  CBA: 'CBA',
  Westpac: 'Westpac',
  NAB: 'NAB',
  ANZ: 'ANZ',
  Macquarie: 'Macquarie',
  ING: 'ING',
  Bendigo: 'Bendigo',
};

const CDR_PRIMARY_PRODUCTS = {
  CBA: { variable: 'Digi Home Loan (OO)', variableInv: 'Digi Home Loan (Inv)' },
  Westpac: { variable: 'Flexi First (OO)', variableInv: 'Flexi First (Inv)', fixed: 'Fixed Rate' },
  NAB: { variable: 'Base Variable', variableAlt: 'Tailored' },
  ANZ: { variable: 'Simplicity PLUS', fixed: 'Fixed Rate' },
  Macquarie: { variable: 'Basic Home Loan' },
  ING: { variable: 'Mortgage Simplifier', fixed: 'Fixed Rate' },
  Bendigo: { variable: 'Easy Home Loan' },
};

// Commercial CDR product mapping (Westpac only)
const CDR_COMMERCIAL_PRODUCTS = {
  Westpac: {
    'secured_business_loan': 'Secured Business Loan',
    'business_overdraft': 'Business Overdraft',
    'unsecured_business_overdraft': 'Unsecured Business Overdraft',
    'unsecured_business_loan': 'Unsecured Business Loan',
    'bbsy_business_loan': 'Bank Bill Business Loan',
    // LOC uses same rates as OD (similar products)
    'business_loc_secured': 'Business Overdraft',
    'unsecured_business_loc': 'Unsecured Business Overdraft',
  }
};

let cdrData = null;

function getRatesJsonUrl() {
  return 'data/rates.json';
}

async function fetchRatesJson() {
  const url = getRatesJsonUrl();
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function findBestRate(rates, lvrMax, rateType, repayment, purpose) {
  if (!rates || !Array.isArray(rates)) return null;

  let candidates = rates.filter(r => {
    if (rateType && r.lendingRateType !== rateType) return false;
    if (repayment && r.repaymentType !== repayment) return false;
    if (purpose && r.loanPurpose && r.loanPurpose !== purpose) return false;
    return true;
  });

  if (candidates.length === 0) return null;

  let lvrMatch = null;
  if (lvrMax) {
    const numLvr = parseInt(lvrMax);
    lvrMatch = candidates.filter(r => {
      if (r.lvrMax === null && r.lvrMin === null) return true;
      if (r.lvrMax && numLvr <= r.lvrMax) return true;
      return false;
    });
    lvrMatch.sort((a, b) => {
      const aMax = a.lvrMax || 999;
      const bMax = b.lvrMax || 999;
      return aMax - bMax;
    });
  }

  const best = (lvrMatch && lvrMatch.length > 0) ? lvrMatch[0] : candidates[0];
  return best ? best.ratePercent : null;
}

function mapCDRToTracker(data) {
  const cat = 'residential';
  let populated = 0;

  for (const [cdrBank, displayBank] of Object.entries(CDR_BANK_MAP)) {
    const bankData = data.banks[cdrBank];
    if (!bankData || !bankData.success) continue;

    const primary = CDR_PRIMARY_PRODUCTS[cdrBank];
    if (!primary) continue;

    if (primary.variable) {
      const product = bankData.products[primary.variable];
      if (product && product.rates) {
        for (const lvr of LVRS) {
          const lvrNum = lvr.key === '80+' ? 90 : parseInt(lvr.key);
          const rate = findBestRate(product.rates, lvrNum, 'VARIABLE', 'PRINCIPAL_AND_INTEREST', 'OWNER_OCCUPIED');
          if (rate) {
            const key = makeKey(cat, displayBank, 'variable', lvr.key);
            if (!rateData[key] || rateData[key].source !== 'manual') {
              rateData[key] = {
                value: rate,
                prev: rateData[key] ? rateData[key].value : null,
                updated: data.fetchedAt,
                source: 'cdr',
              };
              populated++;
            }
          }
        }
      }
    }

    const fixedProduct = primary.fixed;
    if (fixedProduct && bankData.products[fixedProduct]) {
      const product = bankData.products[fixedProduct];
      if (product && product.rates) {
        const fixedMap = { 1: 'fixed1', 2: 'fixed2', 3: 'fixed3' };
        for (const [years, productKey] of Object.entries(fixedMap)) {
          for (const lvr of LVRS) {
            const lvrNum = lvr.key === '80+' ? 90 : parseInt(lvr.key);
            const fixedRates = product.rates.filter(r =>
              r.lendingRateType === 'FIXED' && r.fixedYears === parseInt(years)
            );
            const rate = findBestRate(fixedRates, lvrNum, null, 'PRINCIPAL_AND_INTEREST', 'OWNER_OCCUPIED');
            if (rate) {
              const key = makeKey(cat, displayBank, productKey, lvr.key);
              if (!rateData[key] || rateData[key].source !== 'manual') {
                rateData[key] = {
                  value: rate,
                  prev: rateData[key] ? rateData[key].value : null,
                  updated: data.fetchedAt,
                  source: 'cdr',
                };
                populated++;
              }
            }
          }
        }
      }
    }
  }

  return populated;
}

// ‚îÄ‚îÄ Map CDR data to commercial rates ‚îÄ‚îÄ
function mapCDRToCommercial(data) {
  // Reset commercial rates
  commercialRates = {};

  // Initialize all banks with empty data
  for (const bank of COMM_BANKS) {
    commercialRates[bank.name] = {};
  }

  // Only Westpac has CDR commercial data
  const westpacData = data.banks.Westpac;
  if (!westpacData || !westpacData.success) return;

  const productMapping = CDR_COMMERCIAL_PRODUCTS.Westpac;

  for (const [commKey, cdrProductName] of Object.entries(productMapping)) {
    const product = westpacData.products[cdrProductName];
    if (!product || !product.rates || product.rates.length === 0) continue;

    // Find the VARIABLE rate
    const variableRate = product.rates.find(r => r.lendingRateType === 'VARIABLE');
    if (variableRate) {
      commercialRates['Westpac'][commKey] = {
        rate: variableRate.ratePercent,
        note: variableRate.additionalInfo || null,
        additionalInfo: variableRate.additionalInfo || null,
        source: 'cdr',
      };
    }
  }
}

function updateCDRStatus(data) {
  const el = document.getElementById('lastUpdatedGlobal');
  const commEl = document.getElementById('commLastUpdated');
  if (data && data.fetchedAt) {
    const d = new Date(data.fetchedAt);
    const dateStr = d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    const timeStr = d.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
    const statusHtml = `ü§ñ CDR data: ${dateStr} ${timeStr} &nbsp;|&nbsp; <span style="color:var(--green)">${data.stats.successBanks}/${data.stats.totalBanks} banks</span>`;
    el.innerHTML = statusHtml;
    if (commEl) commEl.innerHTML = statusHtml;
  }
}

async function loadRatesFromCDR(showToastMsg = true) {
  try {
    const btn = document.getElementById('refreshBtn');
    if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Loading...'; }

    const data = await fetchRatesJson();
    cdrData = data;

    const count = mapCDRToTracker(data);
    mapCDRToCommercial(data);
    saveData();
    renderTables();
    updateCDRStatus(data);

    // Re-render commercial if active
    if (currentMode === 'commercial') {
      renderCommercialFlow();
    }

    if (showToastMsg && count > 0) {
      showToast(`CDR rates loaded: ${count} rate entries from ${data.stats.successBanks} banks`, 'ü§ñ');
    }

    if (btn) { btn.disabled = false; btn.textContent = 'üîÑ Refresh Rates'; }
    return true;
  } catch (err) {
    console.warn('Could not load rates.json:', err.message);
    const btn = document.getElementById('refreshBtn');
    if (btn) { btn.disabled = false; btn.textContent = 'üîÑ Refresh Rates'; }

    if (showToastMsg) {
      showToast('CDR rates unavailable ‚Äî using manual data', '‚ö†Ô∏è');
    }
    return false;
  }
}

async function refreshRatesFromAPI() {
  await loadRatesFromCDR(true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadData();
loadCommState();
renderTables();
updateGlobalTimestamp();

// Auto-load CDR rates on page load
loadRatesFromCDR(false);
</script>
</body>
</html>
